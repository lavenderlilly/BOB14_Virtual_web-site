<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì‹¬ë³¸ì¸ì¸ì¦ - PASS - KT ì•Œëœ°í° - ë¬¸ì(SMS)ë¡œ ì¸ì¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-red-600 font-bold text-2xl">P</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">PASS</h1>
            <p class="text-gray-600 mt-2">ì¸ì¦ì„ ë„˜ì–´ ì¼ìƒìœ¼ë¡œ PASS</p>
        </div>

        <!-- 1ë‹¨ê³„: ì…ë ¥ì •ë³´ í™•ì¸ -->
        <div id="step1" class="space-y-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ì…ë ¥ì •ë³´ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                    <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="rrn_front" placeholder="ì•ìë¦¬" maxlength="6" required
                               class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                        <span class="text-gray-400">-</span>
                        <div class="flex items-center space-x-1">
                            <input type="text" id="rrn_back_first" placeholder="1" maxlength="1" required
                                   class="w-8 h-10 px-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-center">
                            <div class="w-8 h-10 px-2 border border-gray-300 rounded-md bg-gray-50 flex items-center justify-center text-gray-400">â€¢</div>
                            <div class="w-8 h-10 px-2 border border-gray-300 rounded-md bg-gray-50 flex items-center justify-center text-gray-400">â€¢</div>
                            <div class="w-8 h-10 px-2 border border-gray-300 rounded-md bg-gray-50 flex items-center justify-center text-gray-400">â€¢</div>
                            <div class="w-8 h-10 px-2 border border-gray-300 rounded-md bg-gray-50 flex items-center justify-center text-gray-400">â€¢</div>
                            <div class="w-8 h-10 px-2 border border-gray-300 rounded-md bg-gray-50 flex items-center justify-center text-gray-400">â€¢</div>
                            <div class="w-8 h-10 px-2 border border-gray-300 rounded-md bg-gray-50 flex items-center justify-center text-gray-400">â€¢</div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">íœ´ëŒ€í° ë²ˆí˜¸</label>
                    <input type="text" id="phone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë³´ì•ˆ ë¬¸ì</label>
                    <div class="flex items-center space-x-2">
                        <div id="captchaDisplay" class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-center font-mono text-lg">
                        </div>
                        <button type="button" onclick="refreshCaptcha()" class="px-3 py-2 text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                        <button type="button" class="px-3 py-2 text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                            </svg>
                        </button>
                    </div>
                    <input type="text" id="captcha" placeholder="ë³´ì•ˆë¬¸ìë¥¼ ì…ë ¥í•˜ì„¸ìš”" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 mt-2">
                </div>
            </div>

            <button type="button" onclick="confirmInfo()" 
                    class="w-full px-4 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 font-medium">
                í™•ì¸
            </button>
        </div>

        <!-- 2ë‹¨ê³„: ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
        <div id="step2" class="hidden space-y-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ë³´ë‚´ë“œë¦° ì¸ì¦ë²ˆí˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</h2>
            
            <div class="space-y-4">
                <div class="flex items-center space-x-2">
                    <input type="text" id="authCode" placeholder="ì¸ì¦ë²ˆí˜¸" maxlength="6" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-center text-lg font-mono">
                    <button type="button" onclick="verifyCode()" 
                            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        í™•ì¸
                    </button>
                </div>

                <div class="flex items-center justify-between text-sm text-gray-600">
                    <div class="flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="timer">2:52</span>
                    </div>
                    <button type="button" onclick="extendTime()" class="text-red-600 hover:text-red-700">
                        ì‹œê°„ì—°ì¥
                    </button>
                </div>
            </div>
        </div>

        <!-- 3ë‹¨ê³„: ì¸ì¦ ì™„ë£Œ -->
        <div id="step3" class="hidden space-y-4">
            <div class="text-center">
                <div id="resultContent" class="text-sm text-gray-600"></div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ì •ë³´ -->
        <div class="mt-8 pt-4 border-t border-gray-200 text-xs text-gray-500 text-center">
            <div class="space-y-1">
                <div class="flex justify-center space-x-4">
                    <a href="#" class="hover:text-gray-700">ì´ìš©ì•½ê´€</a>
                    <a href="#" class="hover:text-gray-700">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                    <a href="#" class="hover:text-gray-700">API ë„ì…ë¬¸ì˜</a>
                </div>
                <p>VeriSign 256-bit SSL ì•”í˜¸í™” ì ìš©</p>
                <div class="flex items-center justify-center space-x-2">
                    <span>NICEí‰ê°€ì •ë³´</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const requestId = urlParams.get('request_id');
        const state = urlParams.get('state');
        const originalNonce = urlParams.get('nonce'); // ì„œë²„ì—ì„œ ë°›ì€ nonce
        
        console.log('URL íŒŒë¼ë¯¸í„°:', {
            requestId: requestId,
            state: state,
            originalNonce: originalNonce
        });

        let timerInterval;
        let timeLeft = 172; // 2ë¶„ 52ì´ˆ

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            refreshCaptcha(); // ë³´ì•ˆë¬¸ì ì´ˆê¸° ìƒì„±
        });

        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert('ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.close();
            }
            timeLeft--;
        }

        // ì‹œê°„ ì—°ì¥
        function extendTime() {
            timeLeft = 172;
            updateTimer();
        }

        // 1ë‹¨ê³„: ì…ë ¥ì •ë³´ í™•ì¸
        function confirmInfo() {
            const name = document.getElementById('name').value;
            const rrnFront = document.getElementById('rrn_front').value;
            const rrnBackFirst = document.getElementById('rrn_back_first').value;
            const phone = document.getElementById('phone').value;
            const captcha = document.getElementById('captcha').value;
            
            if (!name || !rrnFront || !rrnBackFirst || !phone || !captcha) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (rrnFront.length !== 6) {
                alert('ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ì•ìë¦¬ëŠ” 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            if (!rrnBackFirst || rrnBackFirst.length !== 1) {
                alert('ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ë’·ìë¦¬ ì²« ë²ˆì§¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (captcha !== document.getElementById('captchaDisplay').textContent) {
                alert('ë³´ì•ˆë¬¸ìë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // 2ë‹¨ê³„ë¡œ ì´ë™
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            
            // íƒ€ì´ë¨¸ ì‹œì‘
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        // 2ë‹¨ê³„: ì¸ì¦ë²ˆí˜¸ í™•ì¸
        function verifyCode() {
            const authCode = document.getElementById('authCode').value;
            const name = document.getElementById('name').value;
            const rrnFront = document.getElementById('rrn_front').value;
            const rrnBackFirst = document.getElementById('rrn_back_first').value;
            
            if (!authCode || authCode.length !== 6) {
                alert('ì¸ì¦ë²ˆí˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            clearInterval(timerInterval);

            // 3ë‹¨ê³„ë¡œ ì´ë™ (ë¡œë”© ìƒíƒœë¡œ)
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </div>
                    <p class="font-medium">ë³¸ì¸ì¸ì¦ ì²˜ë¦¬ ì¤‘...</p>
                    <p class="text-sm mt-1 text-gray-600">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                </div>
            `;
            
            // í† í° ì „ì†¡ í›„ ê²°ê³¼ì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
            sendToken(name, rrnFront, rrnBackFirst);
        }

        // í† í° ì „ì†¡
        async function sendToken(name, rrnFront, rrnBackFirst) {
            try {
                console.log('ì „ì†¡í•  ë°ì´í„°:', {
                    name: name,
                    rrn: `${rrnFront}-${rrnBackFirst}000000`,
                    nonce: originalNonce,
                    request_id: requestId,
                    state: state
                });
                
                const response = await fetch('/mock_idp_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        rrn: `${rrnFront}-${rrnBackFirst}000000`,
                        nonce: originalNonce || generateNonce(), // nonceê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                        request_id: requestId,
                        state: state
                    })
                });

                if (response.ok) {
                    console.log('í† í° ì „ì†¡ ì„±ê³µ');
                    const result = await response.json();
                    
                    // ì„±ê³µ í˜ì´ì§€ í‘œì‹œ
                    const resultContent = document.getElementById('resultContent');
                    resultContent.innerHTML = `
                        <div class="text-green-800">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <p class="font-medium text-center">âœ… ë³¸ì¸ì¸ì¦ ì„±ê³µ!</p>
                            <p class="text-sm mt-2 text-center"><strong>ì¸ì¦ëœ ì‚¬ìš©ì:</strong> ${name}</p>
                            <p class="text-sm mt-3 text-center text-gray-600">ë³¸ì¸ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    
                    // step2/callback í˜¸ì¶œ
                    try {
                        console.log('step2/callback í˜¸ì¶œ ì¤‘...');
                        const callbackResponse = await fetch('/step2/callback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                request_id: requestId,
                                state: state,
                                idp_signed_token: result.idp_signed_token
                            })
                        });
                        
                        const callbackResult = await callbackResponse.json();
                        console.log('step2/callback ê²°ê³¼:', callbackResult);
                        
                        if (callbackResponse.ok) {
                            console.log('step2/callback ì„±ê³µ');
                            
                            // ìµœì¢… ì™„ë£Œ API í˜¸ì¶œ (ìë™ìœ¼ë¡œ ê°œí†µ ì™„ë£Œ)
                            try {
                                console.log('ìµœì¢… ì™„ë£Œ API í˜¸ì¶œ ì¤‘...');
                                const finalizeResponse = await fetch('/finalize', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ 
                                        sid: callbackResult.sid || requestId 
                                    })
                                });
                                
                                const finalizeResult = await finalizeResponse.json();
                                console.log('ìµœì¢… ì™„ë£Œ ê²°ê³¼:', finalizeResult);
                                
                                if (finalizeResponse.ok) {
                                    console.log('ìµœì¢… ì™„ë£Œ ì„±ê³µ - ê°œí†µ ì™„ë£Œ!');
                                    
                                    // ë¶€ëª¨ ì°½ì— ì„±ê³µ ë©”ì‹œì§€ ì „ë‹¬ (ê°œí†µ ì™„ë£Œ í¬í•¨)
                                    if (window.opener) {
                                        window.opener.postMessage({
                                            type: 'CONTRACT_COMPLETE',
                                            data: finalizeResult,
                                            success: true
                                        }, '*');
                                    }
                                    
                                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                                    const resultContent = document.getElementById('resultContent');
                                    resultContent.innerHTML = `
                                        <div class="text-green-800">
                                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <p class="font-medium text-center">ğŸ‰ ê°œí†µ ì™„ë£Œ!</p>
                                            <p class="text-sm mt-2 text-center">ë³¸ì¸ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì–´</p>
                                            <p class="text-sm mt-1 text-center">íœ´ëŒ€í° ê°œí†µì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                                            <p class="text-sm mt-3 text-center text-gray-600">ê°œí†µ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
                                        </div>
                                    `;
                                    
                                    // 3ì´ˆ í›„ ê°œí†µ ì™„ë£Œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                                    setTimeout(() => {
                                        if (finalizeResult.redirect_url) {
                                            window.location.href = finalizeResult.redirect_url;
                                        } else {
                                            window.close();
                                        }
                                    }, 3000);
                                    
                                } else {
                                    console.error('ìµœì¢… ì™„ë£Œ ì‹¤íŒ¨:', finalizeResult);
                                    
                                    // ë¶€ëª¨ ì°½ì— ì‹¤íŒ¨ ë©”ì‹œì§€ ì „ë‹¬
                                    if (window.opener) {
                                        window.opener.postMessage({
                                            type: 'CONTRACT_FAILURE',
                                            error: finalizeResult.error,
                                            message: finalizeResult.message || 'ìµœì¢… ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                                        }, '*');
                                    }
                                    
                                    // ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
                                    const resultContent = document.getElementById('resultContent');
                                    resultContent.innerHTML = `
                                        <div class="text-red-800">
                                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </div>
                                            <p class="font-medium text-center">âŒ ê°œí†µ ì‹¤íŒ¨!</p>
                                            <p class="text-sm mt-2 text-center">ìµœì¢… ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                                            <p class="text-sm mt-3 text-center text-gray-600">ì´ ì°½ì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>
                                        </div>
                                    `;
                                    
                                    // 5ì´ˆ í›„ ì°½ ë‹«ê¸°
                                    setTimeout(() => {
                                        window.close();
                                    }, 5000);
                                }
                                
                            } catch (finalizeError) {
                                console.error('ìµœì¢… ì™„ë£Œ API ì˜¤ë¥˜:', finalizeError);
                                
                                // ë¶€ëª¨ ì°½ì— ì˜¤ë¥˜ ë©”ì‹œì§€ ì „ë‹¬
                                if (window.opener) {
                                    window.opener.postMessage({
                                        type: 'CONTRACT_FAILURE',
                                        error: 'NETWORK_ERROR',
                                        message: 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸í•´ ê°œí†µì„ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
                                    }, '*');
                                }
                                
                                // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                                const resultContent = document.getElementById('resultContent');
                                resultContent.innerHTML = `
                                    <div class="text-red-800">
                                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </div>
                                        <p class="font-medium text-center">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!</p>
                                        <p class="text-sm mt-2 text-center">ê°œí†µ ì™„ë£Œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                                        <p class="text-sm mt-3 text-center text-gray-600">ì´ ì°½ì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>
                                    </div>
                                `;
                                
                                // 5ì´ˆ í›„ ì°½ ë‹«ê¸°
                                setTimeout(() => {
                                    window.close();
                                }, 5000);
                            }
                        } else {
                            console.error('step2/callback ì‹¤íŒ¨:', callbackResult);
                            
                            // ì‚¬ìš©ì ì¼ì¹˜ì„± ê²€ì¦ ì‹¤íŒ¨ ì²˜ë¦¬
                            if (callbackResult.error === 'USER_MISMATCH') {
                                const resultContent = document.getElementById('resultContent');
                                resultContent.innerHTML = `
                                    <div class="text-red-800">
                                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </div>
                                        <p class="font-medium text-center">âŒ ë³¸ì¸ì¸ì¦ ì‹¤íŒ¨!</p>
                                        <p class="text-sm mt-2 text-center"><strong>ì‚¬ìš©ì ë¶ˆì¼ì¹˜ ì˜¤ë¥˜</strong></p>
                                        <p class="text-sm mt-2 text-center">1ë‹¨ê³„ì™€ 2ë‹¨ê³„ ì¸ì¦ìê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                                        <p class="text-sm mt-3 text-center text-gray-600">ë³¸ì¸ì¸ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                                    </div>
                                `;
                                
                                // ë¶€ëª¨ ì°½ì— ì‹¤íŒ¨ ë©”ì‹œì§€ ì „ë‹¬
                                if (window.opener) {
                                    window.opener.postMessage({
                                        type: 'AUTH_FAILURE',
                                        error: 'USER_MISMATCH',
                                        message: callbackResult.message
                                    }, '*');
                                }
                                
                                // 5ì´ˆ í›„ ì°½ ë‹«ê¸°
                                setTimeout(() => {
                                    window.close();
                                }, 5000);
                                return;
                            }
                        }
                    } catch (callbackError) {
                        console.error('step2/callback ì˜¤ë¥˜:', callbackError);
                    }
                    
                    // 3ì´ˆ í›„ ì°½ ë‹«ê¸°
                    setTimeout(() => {
                        window.close();
                    }, 3000);
                } else {
                    console.error('í† í° ì „ì†¡ ì‹¤íŒ¨');
                    const errorData = await response.json();
                    
                    // ì‹¤íŒ¨ í˜ì´ì§€ë¡œ ë³€ê²½ (ì„±ê³µ ì•„ì´ì½˜ê³¼ ì™„ë£Œ í…ìŠ¤íŠ¸ ì œê±°)
                    const resultContent = document.getElementById('resultContent');
                    resultContent.innerHTML = `
                        <div class="text-red-800">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <p class="font-medium text-center">âŒ ë³¸ì¸ì¸ì¦ ì‹¤íŒ¨!</p>
                            <p class="text-sm mt-2 text-center">ì‚¬ìš©ì ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm mt-3 text-center text-gray-600">ì´ ì°½ì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>
                        </div>
                    `;
                    
                    // 5ì´ˆ í›„ ì°½ ë‹«ê¸°
                    setTimeout(() => {
                        window.close();
                    }, 5000);
                }
            } catch (error) {
                console.error('í† í° ì „ì†¡ ì˜¤ë¥˜:', error);
                
                // ì˜¤ë¥˜ í˜ì´ì§€ë¡œ ë³€ê²½ (ì„±ê³µ ì•„ì´ì½˜ê³¼ ì™„ë£Œ í…ìŠ¤íŠ¸ ì œê±°)
                const resultContent = document.getElementById('resultContent');
                resultContent.innerHTML = `
                    <div class="text-red-800">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                        <p class="font-medium text-center">âŒ ë³¸ì¸ì¸ì¦ ì‹¤íŒ¨!</p>
                        <p class="text-sm mt-2 text-center">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm mt-3 text-center text-gray-600">ì´ ì°½ì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>
                    </div>
                `;
                
                // 5ì´ˆ í›„ ì°½ ë‹«ê¸°
                setTimeout(() => {
                    window.close();
                }, 5000);
            }
        }

        // Nonce ìƒì„± í•¨ìˆ˜
        function generateNonce() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 24; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // 6ìë¦¬ ë³´ì•ˆë¬¸ì ìƒì„± í•¨ìˆ˜
        function generateCaptcha() {
            const digits = '0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += digits.charAt(Math.floor(Math.random() * digits.length));
            }
            return result;
        }

        // ë³´ì•ˆë¬¸ì ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
        function refreshCaptcha() {
            const captchaDisplay = document.getElementById('captchaDisplay');
            const newCaptcha = generateCaptcha();
            captchaDisplay.textContent = newCaptcha;
            document.getElementById('captcha').value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        }

        // Enter í‚¤ë¡œ ì¸ì¦ë²ˆí˜¸ ì…ë ¥
        document.getElementById('authCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyCode();
            }
        });

        // ë³´ì•ˆë¬¸ì Enter í‚¤ ì²˜ë¦¬
        document.getElementById('captcha').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmInfo();
            }
        });

        // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ì•ìë¦¬ ìˆ«ìë§Œ ì…ë ¥
        document.getElementById('rrn_front').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ë’·ìë¦¬ ì²« ë²ˆì§¸ ìˆ«ìë§Œ ì…ë ¥
        document.getElementById('rrn_back_first').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // íœ´ëŒ€í° ë²ˆí˜¸ ìˆ«ìë§Œ ì…ë ¥
        document.getElementById('phone').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë³´ì•ˆë¬¸ì ìƒì„±
        document.addEventListener('DOMContentLoaded', function() {
            refreshCaptcha(); // ì´ˆê¸° ë³´ì•ˆë¬¸ì ìƒì„±
        });
    </script>
</body>
</html>
